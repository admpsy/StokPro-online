<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Movimentação de Produtos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary-color: #4b6cb7;
            --secondary-color: #182848;
            --accent-color: #6a11cb;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-bg: #121212;
            --dark-bg: #1e1e1e;
            --card-bg: #2d2d2d;
            --text-color: #f8f9fa;
            --text-muted: #b0b0b0;
            --text-light: #ffffff;
            --border-color: #444;
            --sidebar-width: 280px;
            --table-header-bg: #343a40;
            --table-row-hover: rgba(255, 255, 255, 0.08);
            --table-striped: rgba(255, 255, 255, 0.05);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.3s ease;
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        /* Layout com sidebar */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--secondary-color) 0%, var(--dark-bg) 100%);
            color: white;
            padding: 0;
            box-shadow: 3px 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: all 0.3s ease;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            background: rgba(0,0,0,0.2);
        }
        
        .sidebar-nav {
            padding: 20px 0;
        }
        
        .nav-item {
            margin-bottom: 5px;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.9);
            padding: 15px 25px;
            border-radius: 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            border-left: 4px solid transparent;
            text-decoration: none;
            font-weight: 500;
        }
        
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: var(--primary-color);
        }
        
        .nav-link i {
            margin-right: 12px;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: var(--sidebar-width);
            background-color: var(--light-bg);
            min-height: 100vh;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .active {
            display: block;
        }
        
        /* Melhorias de legibilidade - textos */
        h1, h2, h3, h4, h5, h6 {
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        h2 {
            font-size: 1.8rem;
        }
        
        p, span, div {
            color: var(--text-color);
        }
        
        .text-muted {
            color: var(--text-muted) !important;
        }
        
        .form-text {
            color: var(--text-muted) !important;
        }
        
        /* Cards e containers */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin-bottom: 24px;
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .card-header {
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.1) 0%, rgba(106, 17, 203, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 18px 24px;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-light);
        }
        
        .card-body {
            padding: 24px;
        }
        
        /* Formulários */
        .form-control, .form-select {
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: var(--text-color);
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: #424242;
            border-color: var(--primary-color);
            color: var(--text-color);
            box-shadow: 0 0 0 0.25rem rgba(75, 108, 183, 0.25);
        }
        
        .form-label {
            color: var(--text-light);
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        /* Tabelas - MELHORIAS APLICADAS */
        .table {
            color: var(--text-color);
            border-color: var(--border-color);
            margin-bottom: 0;
            width: 100%;
            /* Removendo transparência e ajustando espaçamento */
            background-color: var(--card-bg);
        }
        
        .table th {
            background-color: var(--table-header-bg);
            color: var(--text-light);
            font-weight: 600;
            padding: 10px 12px; /* Diminuído o padding */
            border-bottom: 2px solid var(--border-color);
            vertical-align: middle;
        }
        
        .table td {
            padding: 10px 12px; /* Diminuído o padding */
            vertical-align: middle;
            color: var(--text-color);
            border-top: 1px solid var(--border-color);
            /* Removendo transparência */
            background-color: transparent;
        }
        
        .table-striped>tbody>tr:nth-of-type(odd) {
            background-color: var(--table-striped);
        }
        
        .table-hover tbody tr:hover {
            background-color: var(--table-row-hover);
        }
        
        .table-bordered {
            border: 1px solid var(--border-color);
        }
        
        .table-bordered th,
        .table-bordered td {
            border: 1px solid var(--border-color);
        }
        
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* Botões */
        .btn {
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
            padding: 10px 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--primary-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(75, 108, 183, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #1e7e34 100%);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #1e7e34 0%, var(--success-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            background: transparent;
        }
        
        .btn-outline-primary:hover {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        
        .btn-lg {
            padding: 12px 24px;
            font-size: 1.1rem;
        }
        
        /* Badges e status */
        .status-valid {
            background-color: #155724;
            color: #d4edda;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .status-warning {
            background-color: #856404;
            color: #fff3cd;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .status-expired {
            background-color: #721c24;
            color: #f8d7da;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .movement-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            margin: 2px;
            display: inline-block;
        }
        
        .movement-entrada {
            background-color: #155724;
            color: #d4edda;
        }
        
        .movement-saida {
            background-color: #721c24;
            color: #f8d7da;
        }
        
        .movement-devolucao {
            background-color: #856404;
            color: #fff3cd;
        }
        
        /* Foto preview */
        .photo-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .photo-preview {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            transition: transform 0.3s;
        }
        
        .photo-preview:hover {
            transform: scale(1.05);
        }
        
        /* Estrutura expansível para relatórios */
        .report-line {
            padding: 15px 20px;
            border-left: 4px solid var(--primary-color);
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.1) 0%, rgba(106, 17, 203, 0.05) 100%);
            margin-bottom: 15px;
            border-radius: 0 10px 10px 0;
            transition: all 0.3s;
        }
        
        .report-line:hover {
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.15) 0%, rgba(106, 17, 203, 0.1) 100%);
        }
        
        .report-header {
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text-light);
        }
        
        .report-details {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 2px dashed var(--border-color);
        }
        
        .report-item {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .report-item:last-child {
            border-bottom: none;
        }
        
        /* Dashboard cards */
        .stat-card {
            background: linear-gradient(135deg, rgba(75, 108, 183, 0.1) 0%, rgba(106, 17, 203, 0.1) 100%);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
            height: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
            font-weight: 700;
            color: var(--text-light);
        }
        
        .stat-card p {
            color: var(--text-muted);
            margin-bottom: 0;
        }
        
        /* Melhorias para elementos específicos */
        .summary-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(147, 51, 234, 0.1) 100%);
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 10px;
        }
        
        .summary-card h5 {
            color: var(--text-light);
            margin-bottom: 10px;
        }
        
        .batch-indicator {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: bold;
        }
        
        .batch-details {
            padding-left: 40px !important;
        }
        
        .table-action-btn {
            padding: 6px 10px;
            margin: 0 3px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .product-group, .loading-group {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .product-group:hover, .loading-group:hover {
            background-color: rgba(255,255,255,0.1) !important;
        }
        
        .product-details, .loading-details {
            background-color: rgba(255,255,255,0.03);
        }
        
        /* Modal customizado */
        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-color);
        }
        
        .modal-header {
            border-bottom: 1px solid var(--border-color);
            padding: 20px 24px;
        }
        
        .modal-header .modal-title {
            color: var(--text-light);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 20px 24px;
        }
        
        /* Responsividade */
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
            }
            
            .sidebar .nav-link span {
                display: none;
            }
            
            .sidebar .nav-link i {
                margin-right: 0;
            }
            
            .sidebar-header h3, .sidebar-header p {
                display: none;
            }
            
            .sidebar-header {
                padding: 20px 10px;
            }
            
            .main-content {
                margin-left: 80px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .app-container {
                flex-direction: column;
            }
            
            .sidebar-nav {
                display: flex;
                overflow-x: auto;
                padding: 10px;
            }
            
            .nav-item {
                margin-bottom: 0;
                margin-right: 10px;
                flex-shrink: 0;
            }
            
            .nav-link {
                padding: 10px 15px;
                white-space: nowrap;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            
            .nav-link:hover, .nav-link.active {
                border-left: none;
                border-bottom-color: var(--primary-color);
            }
            
            .sidebar-header {
                display: none;
            }
        }
        
        /* Utilitários */
        .text-gradient {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .shadow-custom {
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .border-radius-custom {
            border-radius: 12px;
        }
        
        /* Melhorias de legibilidade para elementos específicos */
        small, .small {
            color: var(--text-muted) !important;
        }
        
        .form-check-label {
            color: var(--text-color);
        }
        
        .input-group-text {
            background-color: #3a3a3a;
            border: 1px solid #555;
            color: var(--text-muted);
        }
        
        /* Estilo para o rodapé de créditos */
        .credits-footer {
            background-color: var(--dark-bg);
            color: var(--text-muted);
            padding: 15px 0;
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 0.9rem;
        }
        
        .credits-footer a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .credits-footer a:hover {
            text-decoration: underline;
        }

        /* Login styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--dark-bg) 100%);
        }
        
        .login-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .user-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        /* Storage toggle */
        .storage-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .storage-toggle .form-check {
            margin: 0;
        }
        
        .storage-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .storage-online {
            background-color: var(--success-color);
            color: white;
        }
        
        .storage-local {
            background-color: var(--warning-color);
            color: black;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="login-page" class="login-container">
        <div class="login-card">
            <h2 class="text-center text-gradient mb-4">Sistema de Controle</h2>
            <form id="login-form">
                <div class="mb-3">
                    <label for="login-email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="login-email" required>
                </div>
                <div class="mb-3">
                    <label for="login-password" class="form-label">Senha</label>
                    <input type="password" class="form-control" id="login-password" required>
                </div>
                <div class="mb-3">
                    <label for="login-role" class="form-label">Tipo de Usuário</label>
                    <select class="form-select" id="login-role" required>
                        <option value="user">Usuário</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">Entrar</button>
                </div>
            </form>
            <div class="mt-3 text-center">
                <small class="text-muted">Sistema desenvolvido por <strong>[Aldemir Garbino]</strong> com auxílio de IA</small>
            </div>
        </div>
    </div>

    <!-- Sistema Principal (inicialmente oculto) -->
    <div id="app-container" class="app-container" style="display: none;">
        <!-- Sidebar de Navegação -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3 class="mb-1">Sistema de Controle</h3>
                <p class="mb-0 small opacity-75">Gestão de Movimentação e Estoque</p>
                <div class="user-badge" id="user-role-badge">Usuário</div>
            </div>
            <div class="sidebar-nav">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-page="dashboard-page">
                            <i class="bi bi-speedometer2"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="stock-report-page">
                            <i class="bi bi-clipboard-data"></i>
                            <span>Relatório de Estoque</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="report-page">
                            <i class="bi bi-box-arrow-in-down"></i>
                            <span>Cadastro de Movimentação</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="products-page">
                            <i class="bi bi-boxes"></i>
                            <span>Estoque de Produtos</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="paletes-page">
                            <i class="bi bi-pallet"></i>
                            <span>Movimentação de Paletes</span>
                        </a>
                    </li>
                    <li class="nav-item mt-4">
                        <a class="nav-link" href="#" data-page="config-page">
                            <i class="bi bi-gear-fill"></i>
                            <span>Configurações</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-danger" href="#" id="logout-btn">
                            <i class="bi bi-box-arrow-left"></i>
                            <span>Sair do Sistema</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <div class="main-content">
            <!-- Dashboard -->
            <div id="dashboard-page" class="page active">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Dashboard</h2>
                    <div class="text-muted">
                        <i class="bi bi-calendar3 me-1"></i>
                        <span id="current-date"></span>
                    </div>
                </div>

                <div class="storage-toggle">
                    <span class="text-muted">Armazenamento:</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="storage-toggle">
                        <label class="form-check-label" for="storage-toggle">
                            <span id="storage-status" class="storage-status storage-local">Local</span>
                        </label>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="bi bi-box-seam"></i>
                            <h3 id="total-products">0</h3>
                            <p class="text-muted">Produtos em Estoque</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="bi bi-arrow-down-circle"></i>
                            <h3 id="total-entradas">0</h3>
                            <p class="text-muted">Entradas Hoje</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="bi bi-arrow-up-circle"></i>
                            <h3 id="total-saidas">0</h3>
                            <p class="text-muted">Saídas Hoje</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="stat-card">
                            <i class="bi bi-exclamation-triangle"></i>
                            <h3 id="total-alertas">0</h3>
                            <p class="text-muted">Alertas</p>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Movimentações Recentes</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Data</th>
                                                <th>Produto</th>
                                                <th>Tipo</th>
                                                <th>Quantidade</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-movements">
                                            <tr>
                                                <td colspan="4" class="text-center">Nenhuma movimentação recente</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Status de Produtos</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3 d-flex justify-content-between align-items-center">
                                    <span class="status-valid">Dentro do Prazo</span>
                                    <span id="count-valid" class="fw-bold">0</span>
                                </div>
                                <div class="mb-3 d-flex justify-content-between align-items-center">
                                    <span class="status-warning">Vencimento Próximo</span>
                                    <span id="count-warning" class="fw-bold">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="status-expired">Vencidos</span>
                                    <span id="count-expired" class="fw-bold">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Relatório de Estoque -->
            <div id="stock-report-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Relatório de Estoque</h2>
                    <div>
                        <button id="generate-stock-pdf" class="btn btn-primary me-2">
                            <i class="bi bi-file-earmark-pdf me-1"></i>Exportar PDF
                        </button>
                        <button id="generate-stock-excel" class="btn btn-success">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Exportar Excel
                        </button>
                    </div>
                </div>

                <div class="storage-toggle">
                    <span class="text-muted">Armazenamento:</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="storage-toggle-stock">
                        <label class="form-check-label" for="storage-toggle-stock">
                            <span id="storage-status-stock" class="storage-status storage-local">Local</span>
                        </label>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="stock-filter-date" class="form-label">Data do Relatório</label>
                                <input type="date" class="form-control" id="stock-filter-date">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="btn-group w-100">
                                    <button id="apply-stock-filters" class="btn btn-primary me-2 flex-fill">Filtrar</button>
                                    <button id="reset-stock-filters" class="btn btn-outline-secondary flex-fill">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Nº Relatório</th>
                                        <th>Data</th>
                                        <th>Movimentação</th>
                                        <th>Total de Itens</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="stock-list">
                                    <tr>
                                        <td colspan="5" class="text-center">Nenhum relatório encontrado</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Cadastro de Movimentação -->
            <div id="report-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Cadastro de Movimentação</h2>
                    <div>
                        <button id="view-history" class="btn btn-outline-secondary me-2">
                            <i class="bi bi-clock-history me-1"></i>Histórico
                        </button>
                    </div>
                </div>

                <div class="storage-toggle">
                    <span class="text-muted">Armazenamento:</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="storage-toggle-report">
                        <label class="form-check-label" for="storage-toggle-report">
                            <span id="storage-status-report" class="storage-status storage-local">Local</span>
                        </label>
                    </div>
                </div>

                <div class="summary-card mb-4">
                    <h5>Resumo do Relatório</h5>
                    <p id="summary-text">Nenhum item adicionado ainda</p>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Adicionar Item</h5>
                    </div>
                    <div class="card-body">
                        <form id="movement-form">
                            <div class="row">
                                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Data</label>
                                    <input type="date" class="form-control" id="input-date" required>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Tipo Movimento</label>
                                    <select class="form-select" id="input-movementType" required>
                                        <option value="Entrada">Entrada</option>
                                        <option value="Saída">Saída</option>
                                        <option value="Devolução">Devolução</option>
                                    </select>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Produto</label>
                                    <select class="form-select" id="input-product" required>
                                        <option value="">Selecione um produto</option>
                                    </select>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Quantidade</label>
                                    <input type="number" class="form-control" id="input-quantity" min="1" value="1" required>
                                </div>
                                <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Tipo Produto</label>
                                    <input type="text" class="form-control" id="input-productType" readonly>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Lote</label>
                                    <select class="form-select" id="input-batch">
                                        <option value="">Selecione um lote</option>
                                    </select>
                                    <div id="lote-info" class="form-text"></div>
                                </div>
                                <div class="col-md-4 col-sm-6 mb-3">
                                    <label class="form-label">Data Fabricação</label>
                                    <input type="date" class="form-control" id="input-manufacturingDate">
                                </div>
                                <div class="col-md-4 col-12 d-flex align-items-end">
                                    <button type="button" id="add-to-table" class="btn btn-primary w-100">
                                        <i class="bi bi-plus-circle me-1"></i>Adicionar Item
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mb-4" id="products-table-container" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">Itens Adicionados</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Movimento</th>
                                        <th>Produto</th>
                                        <th>Quantidade</th>
                                        <th>Tipo</th>
                                        <th>Lote</th>
                                        <th>Fabricação</th>
                                        <th>Disponível</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Fotos (opcional)</h5>
                    </div>
                    <div class="card-body">
                        <input type="file" class="form-control" id="photos" multiple accept="image/*">
                        <div id="photo-previews" class="photo-preview-container mt-3"></div>
                    </div>
                </div>
                
                <div class="d-grid">
                    <button type="button" id="generate-pdf" class="btn btn-primary btn-lg">
                        <i class="bi bi-file-earmark-pdf me-2"></i>Gerar PDF e Salvar Relatório
                    </button>
                </div>
            </div>

            <!-- Tela de Estoque de Produtos -->
            <div id="products-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Estoque de Produtos</h2>
                    <div>
                        <button id="export-products-excel" class="btn btn-success me-2">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Exportar para Excel
                        </button>
                        <button id="add-product" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Adicionar Produto
                        </button>
                    </div>
                </div>

                <div class="storage-toggle">
                    <span class="text-muted">Armazenamento:</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="storage-toggle-products">
                        <label class="form-check-label" for="storage-toggle-products">
                            <span id="storage-status-products" class="storage-status storage-local">Local</span>
                        </label>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="products-filter-sku" class="form-label">SKU</label>
                                <input type="text" class="form-control" id="products-filter-sku" placeholder="Código SKU">
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="products-filter-name" class="form-label">Produto</label>
                                <input type="text" class="form-control" id="products-filter-name" placeholder="Nome do produto">
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <label for="products-filter-type" class="form-label">Tipo de Produto</label>
                                <select class="form-select" id="products-filter-type">
                                    <option value="">Todos</option>
                                    <option value="Tambor">Tambor</option>
                                    <option value="Balde">Balde</option>
                                    <option value="Bombona">Bombona</option>
                                    <option value="IBC1000L">IBC1000L</option>
                                    <option value="Caixa">Caixa</option>
                                </select>
                            </div>
                            <div class="col-md-3 col-12 mb-3 d-flex align-items-end">
                                <div class="btn-group w-100">
                                    <button id="apply-products-filters" class="btn btn-primary me-2 flex-fill">Filtrar</button>
                                    <button id="reset-products-filters" class="btn btn-outline-secondary flex-fill">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>SKU</th>
                                        <th>Produto</th>
                                        <th>Tipo</th>
                                        <th>Quantidade Total</th>
                                        <th>Lotes</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="products-list">
                                    <tr>
                                        <td colspan="6" class="text-center">Nenhum produto encontrado</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela de Movimentação de Paletes (ATUALIZADA) -->
            <div id="paletes-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Movimentação de Paletes</h2>
                    <div>
                        <button id="generate-paletes-pdf" class="btn btn-primary me-2">
                            <i class="bi bi-file-earmark-pdf me-1"></i>Gerar PDF
                        </button>
                        <button id="generate-paletes-excel" class="btn btn-success">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Exportar Excel
                        </button>
                    </div>
                </div>

                <div class="storage-toggle">
                    <span class="text-muted">Armazenamento:</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="storage-toggle-paletes">
                        <label class="form-check-label" for="storage-toggle-paletes">
                            <span id="storage-status-paletes" class="storage-status storage-local">Local</span>
                        </label>
                    </div>
                </div>

                <!-- Filtro de data para o relatório -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Filtros do Relatório</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="paletes-filter-date" class="form-label">Data do Relatório</label>
                                <input type="date" class="form-control" id="paletes-filter-date">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="btn-group w-100">
                                    <button id="apply-paletes-filters" class="btn btn-primary me-2 flex-fill">Filtrar</button>
                                    <button id="reset-paletes-filters" class="btn btn-outline-secondary flex-fill">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Relatório Diário de Paletes</h5>
                    </div>
                    <div class="card-body">
                        <div id="paletes-report-container">
                            <!-- Estrutura expansível será gerada dinamicamente aqui -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Adicionar Movimentação de Paletes</h5>
                    </div>
                    <div class="card-body">
                        <form id="paletes-form">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Data</label>
                                    <input type="date" class="form-control" id="paletes-date" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Tipo de Palete</label>
                                    <select class="form-select" id="paletes-type" required>
                                        <option value="Fracionado">Fracionado</option>
                                        <option value="Tambor">Tambor</option>
                                        <option value="IBC 1000L">IBC 1000L</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Tipo de Movimento</label>
                                    <select class="form-select" id="paletes-movement" required>
                                        <option value="Entrada">Entrada</option>
                                        <option value="Saída">Saída</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Quantidade</label>
                                    <input type="number" class="form-control" id="paletes-quantity" min="1" value="1" required>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="button" id="add-paletes-item" class="btn btn-primary">
                                    <i class="bi bi-plus-circle me-1"></i>Adicionar Movimentação
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tela de Configurações -->
            <div id="config-page" class="page">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-gradient">Configurações do Sistema</h2>
                </div>

                <div class="storage-toggle">
                    <span class="text-muted">Armazenamento:</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="storage-toggle-config">
                        <label class="form-check-label" for="storage-toggle-config">
                            <span id="storage-status-config" class="storage-status storage-local">Local</span>
                        </label>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Configurações do Firebase</h5>
                    </div>
                    <div class="card-body">
                        <form id="firebase-config-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="firebase-apiKey" class="form-label">API Key</label>
                                    <input type="text" class="form-control" id="firebase-apiKey" placeholder="Sua chave API do Firebase">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="firebase-authDomain" class="form-label">Auth Domain</label>
                                    <input type="text" class="form-control" id="firebase-authDomain" placeholder="seu-projeto.firebaseapp.com">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="firebase-projectId" class="form-label">Project ID</label>
                                    <input type="text" class="form-control" id="firebase-projectId" placeholder="ID do seu projeto">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="firebase-storageBucket" class="form-label">Storage Bucket</label>
                                    <input type="text" class="form-control" id="firebase-storageBucket" placeholder="seu-projeto.appspot.com">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="firebase-messagingSenderId" class="form-label">Messaging Sender ID</label>
                                    <input type="text" class="form-control" id="firebase-messagingSenderId" placeholder="Seu sender ID">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="firebase-appId" class="form-label">App ID</label>
                                    <input type="text" class="form-control" id="firebase-appId" placeholder="Seu App ID">
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="button" id="save-firebase-config" class="btn btn-primary">
                                    <i class="bi bi-cloud-upload me-1"></i>Salvar Configurações do Firebase
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="mb-4">
                            <h5>Preferências de Exibição</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="dark-mode-toggle" checked>
                                <label class="form-check-label" for="dark-mode-toggle">Modo escuro</label>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5>Notificações</h5>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notify-expiry" checked>
                                <label class="form-check-label" for="notify-expiry">Alertas de vencimento</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notify-low-stock" checked>
                                <label class="form-check-label" for="notify-low-stock">Alertas de estoque baixo</label>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5>Relatórios</h5>
                            <div class="mb-3">
                                <label for="report-format" class="form-label">Formato padrão de relatório</label>
                                <select class="form-select" id="report-format">
                                    <option value="pdf" selected>PDF</option>
                                    <option value="excel">Excel</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" id="save-config-btn" class="btn btn-primary">
                                <i class="bi bi-check-circle me-1"></i>Salvar Configurações
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rodapé com créditos -->
    <div class="credits-footer">
        <div class="container">
            <p>Sistema desenvolvido por <strong>[Aldemir Garbino]</strong> com auxílio de IA</p>
            <p class="mb-0">© 2025 - Todos os direitos reservados</p>
        </div>
    </div>

    <!-- Modal para Adicionar Produto -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Produto ao Estoque</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-product-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="new-product-sku" class="form-label">SKU *</label>
                                <input type="text" class="form-control" id="new-product-sku" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new-product-name" class="form-label">Produto *</label>
                                <input type="text" class="form-control" id="new-product-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new-product-type" class="form-label">Tipo de Produto *</label>
                                <select class="form-select" id="new-product-type" required>
                                    <option value="Tambor">Tambor</option>
                                    <option value="Balde">Balde</option>
                                    <option value="Bombona">Bombona</option>
                                    <option value="IBC1000L">IBC1000L</option>
                                    <option value="Caixa">Caixa</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new-product-quantity" class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" id="new-product-quantity" min="0" value="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new-product-batch" class="form-label">Lote</label>
                                <input type="text" class="form-control" id="new-product-batch" placeholder="Opcional">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new-product-manufacturing-date" class="form-label">Data de Fabricação *</label>
                                <input type="date" class="form-control" id="new-product-manufacturing-date" required>
                            </div>
                        </div>
                        <p class="text-muted">* Campos obrigatórios</p>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-new-product">Salvar Produto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Lote -->
    <div class="modal fade" id="loteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loteModalTitle">Adicionar Lote ao Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="lote-form">
                        <input type="hidden" id="lote-sku">
                        <input type="hidden" id="lote-index">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="lote-quantity" class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" id="lote-quantity" min="1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lote-batch" class="form-label">Lote</label>
                                <input type="text" class="form-control" id="lote-batch" placeholder="Opcional">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lote-manufacturing-date" class="form-label">Data de Fabricação *</label>
                                <input type="date" class="form-control" id="lote-manufacturing-date" required>
                            </div>
                        </div>
                        <p class="text-muted">* Campos obrigatórios</p>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-lote">Salvar Lote</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Produto -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-product-form">
                        <input type="hidden" id="edit-product-index">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-product-sku" class="form-label">SKU *</label>
                                <input type="text" class="form-control" id="edit-product-sku" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-product-name" class="form-label">Produto *</label>
                                <input type="text" class="form-control" id="edit-product-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-product-type" class="form-label">Tipo de Produto *</label>
                                <select class="form-select" id="edit-product-type" required>
                                    <option value="Tambor">Tambor</option>
                                    <option value="Balde">Balde</option>
                                    <option value="Bombona">Bombona</option>
                                    <option value="IBC1000L">IBC1000L</option>
                                    <option value="Caixa">Caixa</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-product-quantity" class="form-label">Quantidade *</label>
                                <input type="number" class="form-control" id="edit-product-quantity" min="0" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-product-batch" class="form-label">Lote</label>
                                <input type="text" class="form-control" id="edit-product-batch" placeholder="Opcional">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-product-manufacturing-date" class="form-label">Data de Fabricação *</label>
                                <input type="date" class="form-control" id="edit-product-manufacturing-date" required>
                            </div>
                        </div>
                        <p class="text-muted">* Campos obrigatórios</p>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="update-product">Atualizar Produto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Histórico -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Histórico de Movimentações</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" placeholder="Buscar no histórico..." id="historySearch">
                            <button class="btn btn-outline-secondary" type="button" id="clearHistorySearch">Limpar</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Movimento</th>
                                    <th>Produto</th>
                                    <th>Quantidade</th>
                                    <th>Lote</th>
                                    <th>Disponível</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">Nenhum registro encontrado</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-danger" id="clearHistoryBtn">Limpar Histórico</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Relatório de Paletes -->
    <div class="modal fade" id="editPaletesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Relatório de Paletes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-paletes-form">
                        <input type="hidden" id="edit-paletes-id">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Data</label>
                                <input type="date" class="form-control" id="edit-paletes-date" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Tipo de Palete</label>
                                <select class="form-select" id="edit-paletes-type" required>
                                    <option value="Fracionado">Fracionado</option>
                                    <option value="Tambor">Tambor</option>
                                    <option value="IBC 1000L">IBC 1000L</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Tipo de Movimento</label>
                                <select class="form-select" id="edit-paletes-movement" required>
                                    <option value="Entrada">Entrada</option>
                                    <option value="Saída">Saída</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Quantidade</label>
                                <input type="number" class="form-control" id="edit-paletes-quantity" min="1" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="update-paletes-item">Atualizar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuração do Firebase e Sistema de Login
        let firebaseApp = null;
        let db = null;
        let currentUser = null;
        let userRole = 'user';
        let useOnlineStorage = false;

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se há configuração salva do Firebase
            const firebaseConfig = getFirebaseConfig();
            if (firebaseConfig && firebaseConfig.apiKey) {
                initializeFirebase(firebaseConfig);
            }

            // Configurar data atual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-date').value = today;
            document.getElementById('paletes-date').value = today;
            document.getElementById('stock-filter-date').value = today;
            document.getElementById('paletes-filter-date').value = today;
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('pt-BR');
            
            // Configurar navegação
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                    
                    // Atualizar navegação ativa
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Botão de logout
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Tem certeza que deseja sair do sistema?')) {
                    logout();
                }
            });
            
            // Inicializar dados
            initializeData();
            loadProductsForMovement();
            loadProductsData();
            loadStockReport();
            loadPaletesData();
            updateDashboard();
            
            // Configurar eventos
            setupEventListeners();
            setupStorageToggle();
            
            // Configurar formulário de login
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        });

        // Sistema de Login
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const role = document.getElementById('login-role').value;
            
            // Simulação de login (em produção, isso seria feito com Firebase Auth)
            if (email && password) {
                currentUser = {
                    email: email,
                    role: role
                };
                userRole = role;
                
                // Mostrar sistema principal
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                
                // Atualizar badge do usuário
                document.getElementById('user-role-badge').textContent = role === 'admin' ? 'Administrador' : 'Usuário';
                
                alert(`Login realizado com sucesso! Bem-vindo, ${email}`);
            } else {
                alert('Por favor, preencha todos os campos!');
            }
        }

        function logout() {
            currentUser = null;
            userRole = 'user';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('login-form').reset();
        }

        // Sistema de Armazenamento Online/Local
        function setupStorageToggle() {
            const toggles = [
                'storage-toggle', 'storage-toggle-stock', 'storage-toggle-report',
                'storage-toggle-products', 'storage-toggle-paletes', 'storage-toggle-config'
            ];
            
            toggles.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.addEventListener('change', function() {
                        useOnlineStorage = this.checked;
                        updateStorageStatus();
                        
                        // Recarregar dados conforme a página atual
                        const activePage = document.querySelector('.page.active').id;
                        switch(activePage) {
                            case 'products-page':
                                loadProductsData();
                                break;
                            case 'stock-report-page':
                                loadStockReport();
                                break;
                            case 'paletes-page':
                                loadPaletesData();
                                break;
                            case 'dashboard-page':
                                updateDashboard();
                                break;
                        }
                    });
                }
            });
        }

        function updateStorageStatus() {
            const statusElements = [
                'storage-status', 'storage-status-stock', 'storage-status-report',
                'storage-status-products', 'storage-status-paletes', 'storage-status-config'
            ];
            
            statusElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    if (useOnlineStorage) {
                        element.textContent = 'Online';
                        element.className = 'storage-status storage-online';
                    } else {
                        element.textContent = 'Local';
                        element.className = 'storage-status storage-local';
                    }
                }
            });
        }

        // Configuração do Firebase
        function getFirebaseConfig() {
            return JSON.parse(localStorage.getItem('firebaseConfig') || '{}');
        }

        function saveFirebaseConfig(config) {
            localStorage.setItem('firebaseConfig', JSON.stringify(config));
        }

        function initializeFirebase(config) {
            try {
                firebaseApp = firebase.initializeApp(config);
                db = firebase.firestore();
                console.log('Firebase inicializado com sucesso');
                return true;
            } catch (error) {
                console.error('Erro ao inicializar Firebase:', error);
                return false;
            }
        }

        // Funções de armazenamento online
        async function saveDataOnline(collection, data) {
            if (!db || !useOnlineStorage) return false;
            
            try {
                await db.collection(collection).doc('data').set({
                    data: data,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return true;
            } catch (error) {
                console.error('Erro ao salvar online:', error);
                return false;
            }
        }

        async function loadDataOnline(collection) {
            if (!db || !useOnlineStorage) return null;
            
            try {
                const doc = await db.collection(collection).doc('data').get();
                if (doc.exists) {
                    return doc.data().data;
                }
                return null;
            } catch (error) {
                console.error('Erro ao carregar online:', error);
                return null;
            }
        }

        // Função para inicializar dados
        function initializeData() {
            // Produtos
            if (!localStorage.getItem('productsData')) {
                const productsData = [
                    { 
                        SKU: "PROD001", 
                        Produto: "Produto A", 
                        Tipo: "Tambor", 
                        Quantidade: 50,
                        Lote: "LOTE-001",
                        'Data Fabricação': "2022-05-15",
                        Entradas: 50,
                        Saídas: 0,
                        id: 1
                    }
                ];
                localStorage.setItem('productsData', JSON.stringify(productsData));
            }
            
            // Histórico de movimentações
            if (!localStorage.getItem('movementHistory')) {
                const today = new Date().toISOString().split('T')[0];
                const movementHistory = [
                    {
                        id: 1,
                        timestamp: new Date().toISOString(),
                        date: today,
                        movementType: 'Entrada',
                        productSKU: 'PROD001',
                        productName: 'Produto A',
                        quantity: 50,
                        productType: 'Tambor',
                        batch: 'LOTE-001',
                        manufacturingDate: '2023-05-15'
                    }
                ];
                localStorage.setItem('movementHistory', JSON.stringify(movementHistory));
            }
            
            // Relatórios de estoque
            if (!localStorage.getItem('reportsHistory')) {
                const today = new Date().toISOString().split('T')[0];
                const reportsHistory = [
                    {
                        reportNumber: 1,
                        date: today,
                        timestamp: new Date().toISOString(),
                        items: [
                            {
                                date: today,
                                movementType: 'Entrada',
                                productName: 'Produto A',
                                quantity: 50,
                                productType: 'Tambor',
                                batch: 'LOTE-001',
                                manufacturingDate: '2023-05-15'
                            }
                        ],
                        photos: [] // Array para armazenar fotos
                    }
                ];
                localStorage.setItem('reportsHistory', JSON.stringify(reportsHistory));
            }
            
            // Movimentação de paletes
            if (!localStorage.getItem('paletesData')) {
                const today = new Date().toISOString().split('T')[0];
                const paletesData = [
                    {
                        id: 1,
                        date: today,
                        reportNumber: 1,
                        items: [
                            { type: 'Fracionado', movement: 'Entrada', quantity: 15 }
                        ]
                    }
                ];
                localStorage.setItem('paletesData', JSON.stringify(paletesData));
            }
        }

        // Função para configurar event listeners
        function setupEventListeners() {
            // Produtos
            document.getElementById('add-product').addEventListener('click', function() {
                document.getElementById('add-product-form').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('new-product-manufacturing-date').value = today;
                new bootstrap.Modal(document.getElementById('addProductModal')).show();
            });
            
            document.getElementById('save-new-product').addEventListener('click', addNewProduct);
            document.getElementById('save-lote').addEventListener('click', saveLote);
            document.getElementById('update-product').addEventListener('click', updateProduct);
            
            // Movimentação
            document.getElementById('input-product').addEventListener('change', function() {
                updateProductDetails();
                loadLotesForProduct();
            });
            
            document.getElementById('input-movementType').addEventListener('change', function() {
                loadLotesForProduct();
            });
            
            document.getElementById('add-to-table').addEventListener('click', addItemToTable);
            document.getElementById('generate-pdf').addEventListener('click', generatePDF);
            
            // Filtros
            document.getElementById('apply-stock-filters').addEventListener('click', function() {
                loadStockReport();
            });
            
            document.getElementById('reset-stock-filters').addEventListener('click', function() {
                document.getElementById('stock-filter-date').value = '';
                loadStockReport();
            });
            
            document.getElementById('apply-products-filters').addEventListener('click', function() {
                loadProductsData();
            });
            
            document.getElementById('reset-products-filters').addEventListener('click', function() {
                document.getElementById('products-filter-sku').value = '';
                document.getElementById('products-filter-name').value = '';
                document.getElementById('products-filter-type').value = '';
                loadProductsData();
            });
            
            // Eventos para filtros de paletes
            document.getElementById('apply-paletes-filters').addEventListener('click', function() {
                loadPaletesData();
            });
            
            document.getElementById('reset-paletes-filters').addEventListener('click', function() {
                document.getElementById('paletes-filter-date').value = '';
                loadPaletesData();
            });
            
            // Histórico
            document.getElementById('view-history').addEventListener('click', function() {
                loadHistoryData();
                new bootstrap.Modal(document.getElementById('historyModal')).show();
            });
            
            document.getElementById('clearHistoryBtn').addEventListener('click', function() {
                if (confirm('Tem certeza que deseja limpar todo o histórico? Esta ação não pode ser desfeita.')) {
                    localStorage.removeItem('movementHistory');
                    if (useOnlineStorage) {
                        saveDataOnline('movementHistory', []);
                    }
                    loadHistoryData();
                    alert('Histórico limpo com sucesso!');
                }
            });
            
            document.getElementById('historySearch').addEventListener('input', function() {
                filterHistory(this.value);
            });
            
            document.getElementById('clearHistorySearch').addEventListener('click', function() {
                document.getElementById('historySearch').value = '';
                filterHistory('');
            });
            
            // Exportações
            document.getElementById('generate-stock-pdf').addEventListener('click', generateStockPDF);
            document.getElementById('generate-stock-excel').addEventListener('click', generateStockExcel);
            document.getElementById('export-products-excel').addEventListener('click', exportProductsExcel);
            document.getElementById('generate-paletes-pdf').addEventListener('click', generatePaletesPDF);
            document.getElementById('generate-paletes-excel').addEventListener('click', generatePaletesExcel);
            
            // Paletes
            document.getElementById('add-paletes-item').addEventListener('click', addPaletesItem);
            
            // Configurações do Firebase
            document.getElementById('save-firebase-config').addEventListener('click', function() {
                const config = {
                    apiKey: document.getElementById('firebase-apiKey').value,
                    authDomain: document.getElementById('firebase-authDomain').value,
                    projectId: document.getElementById('firebase-projectId').value,
                    storageBucket: document.getElementById('firebase-storageBucket').value,
                    messagingSenderId: document.getElementById('firebase-messagingSenderId').value,
                    appId: document.getElementById('firebase-appId').value
                };
                
                if (initializeFirebase(config)) {
                    saveFirebaseConfig(config);
                    alert('Configurações do Firebase salvas com sucesso!');
                } else {
                    alert('Erro ao configurar Firebase. Verifique os dados informados.');
                }
            });
            
            // Configurações
            document.getElementById('save-config-btn').addEventListener('click', function() {
                alert('Configurações salvas com sucesso!');
            });
            
            // Upload de fotos
            document.getElementById('photos').addEventListener('change', handlePhotoUpload);
        }

        // Array para armazenar os produtos (para a tela de movimentação)
        let productsList = [];
        
        // Array para armazenar as fotos
        let uploadedPhotos = [];
        
        // Função para lidar com upload de fotos
        function handlePhotoUpload(e) {
            const files = e.target.files;
            const previewContainer = document.getElementById('photo-previews');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'photo-preview';
                        img.alt = 'Preview da foto';
                        
                        // Adicionar botão de remover
                        const container = document.createElement('div');
                        container.className = 'position-relative d-inline-block';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0';
                        removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                        removeBtn.style.transform = 'translate(30%, -30%)';
                        
                        removeBtn.addEventListener('click', function() {
                            container.remove();
                            // Remover também do array uploadedPhotos
                            const index = uploadedPhotos.findIndex(photo => photo.data === e.target.result);
                            if (index !== -1) {
                                uploadedPhotos.splice(index, 1);
                            }
                        });
                        
                        container.appendChild(img);
                        container.appendChild(removeBtn);
                        previewContainer.appendChild(container);
                        
                        // Armazenar a foto para o PDF
                        uploadedPhotos.push({
                            data: e.target.result,
                            width: 4, // 4x4 no PDF
                            height: 4
                        });
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        }

        // Função para mostrar página específica
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            
            // Atualizar dados específicos da página
            if (pageId === 'products-page') {
                loadProductsData();
            } else if (pageId === 'report-page') {
                loadProductsForMovement();
            } else if (pageId === 'stock-report-page') {
                loadStockReport();
            } else if (pageId === 'paletes-page') {
                loadPaletesData();
            } else if (pageId === 'dashboard-page') {
                updateDashboard();
            } else if (pageId === 'config-page') {
                loadFirebaseConfig();
            }
        }

        // Função para carregar configuração do Firebase
        function loadFirebaseConfig() {
            const config = getFirebaseConfig();
            if (config) {
                document.getElementById('firebase-apiKey').value = config.apiKey || '';
                document.getElementById('firebase-authDomain').value = config.authDomain || '';
                document.getElementById('firebase-projectId').value = config.projectId || '';
                document.getElementById('firebase-storageBucket').value = config.storageBucket || '';
                document.getElementById('firebase-messagingSenderId').value = config.messagingSenderId || '';
                document.getElementById('firebase-appId').value = config.appId || '';
            }
        }

        // Função para atualizar o dashboard
        async function updateDashboard() {
            let productsData, movementHistory;
            
            if (useOnlineStorage) {
                productsData = await loadDataOnline('productsData') || [];
                movementHistory = await loadDataOnline('movementHistory') || [];
            } else {
                productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
                movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            // Total de produtos
            const uniqueProducts = [...new Set(productsData.map(p => p.SKU))];
            document.getElementById('total-products').textContent = uniqueProducts.length;
            
            // Movimentações do dia
            const todayMovements = movementHistory.filter(m => m.date === today);
            const entradas = todayMovements.filter(m => m.movementType === 'Entrada').reduce((sum, m) => sum + m.quantity, 0);
            const saidas = todayMovements.filter(m => m.movementType === 'Saída').reduce((sum, m) => sum + m.quantity, 0);
            
            document.getElementById('total-entradas').textContent = entradas;
            document.getElementById('total-saidas').textContent = saidas;
            
            // Alertas (produtos próximos do vencimento ou vencidos)
            let alertCount = 0;
            let validCount = 0;
            let warningCount = 0;
            let expiredCount = 0;
            
            productsData.forEach(product => {
                const expiryDate = calculateExpiryDate(product['Data Fabricação']);
                const status = checkProductStatus(expiryDate);
                
                if (status.status === "Vencido") {
                    expiredCount++;
                    alertCount++;
                } else if (status.status === "Vencimento Próximo") {
                    warningCount++;
                    alertCount++;
                } else {
                    validCount++;
                }
            });
            
            document.getElementById('total-alertas').textContent = alertCount;
            document.getElementById('count-valid').textContent = validCount;
            document.getElementById('count-warning').textContent = warningCount;
            document.getElementById('count-expired').textContent = expiredCount;
            
            // Movimentações recentes (últimas 5)
            const recentMovements = movementHistory
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            const tbody = document.getElementById('recent-movements');
            tbody.innerHTML = '';
            
            if (recentMovements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhuma movimentação recente</td></tr>';
                return;
            }
            
            recentMovements.forEach(movement => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(movement.date)}</td>
                    <td>${movement.productName}</td>
                    <td>${movement.movementType}</td>
                    <td>${movement.quantity}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Função para carregar dados de paletes (ATUALIZADA)
        async function loadPaletesData() {
            let paletesData;
            
            if (useOnlineStorage) {
                paletesData = await loadDataOnline('paletesData') || [];
            } else {
                paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            }
            
            const filterDate = document.getElementById('paletes-filter-date').value;
            const container = document.getElementById('paletes-report-container');
            
            container.innerHTML = '';
            
            if (paletesData.length === 0) {
                container.innerHTML = '<p class="text-center">Nenhum relatório de paletes encontrado</p>';
                return;
            }
            
            // Filtrar por data se fornecida
            let filteredData = paletesData;
            if (filterDate) {
                filteredData = paletesData.filter(report => report.date === filterDate);
            }
            
            // Ordenar por data (mais recente primeiro)
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p class="text-center">Nenhum relatório encontrado para a data selecionada</p>';
                return;
            }
            
            filteredData.forEach(report => {
                const reportElement = document.createElement('div');
                reportElement.className = 'report-line mb-3';
                
                // Cabeçalho do relatório
                const header = document.createElement('div');
                header.className = 'report-header';
                header.innerHTML = `
                    <span>📊 Relatório Diário - ${formatDate(report.date)} - Nº ${report.reportNumber.toString().padStart(6, '0')}</span>
                    <div>
                        ${userRole === 'admin' ? `
                        <button class="btn btn-sm btn-warning edit-paletes-report" data-id="${report.id}" title="Editar relatório">
                            <i class="bi bi-pencil"></i>
                        </button>
                        ` : ''}
                        <i class="bi bi-chevron-down"></i>
                    </div>
                `;
                
                // Detalhes do relatório
                const details = document.createElement('div');
                details.className = 'report-details';
                details.style.display = 'none';
                
                const movimentacaoTitle = document.createElement('div');
                movimentacaoTitle.innerHTML = '<strong>🏭 MOVIMENTAÇÃO DE PALETES</strong>';
                details.appendChild(movimentacaoTitle);
                
                // Calcular totais
                let totalEntradas = 0;
                let totalSaidas = 0;
                
                report.items.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'report-item';
                    itemElement.innerHTML = `
                        <span>${item.type}</span>
                        <span>
                            ${item.movement === 'Entrada' ? 'Entrada' : 'Saída'}: ${item.quantity} paletes
                            ${userRole === 'admin' ? `
                            <button class="btn btn-sm btn-outline-warning ms-2 edit-paletes-item" 
                                    data-report-id="${report.id}" data-item-index="${index}" title="Editar item">
                                <i class="bi bi-pencil"></i>
                            </button>
                            ` : ''}
                        </span>
                    `;
                    details.appendChild(itemElement);
                    
                    // Calcular totais
                    if (item.movement === 'Entrada') {
                        totalEntradas += item.quantity;
                    } else {
                        totalSaidas += item.quantity;
                    }
                });
                
                // Adicionar linha de totais
                const totalElement = document.createElement('div');
                totalElement.className = 'report-item mt-2 pt-2 border-top';
                totalElement.innerHTML = `
                    <span><strong>TOTAIS</strong></span>
                    <span><strong>Entradas: ${totalEntradas} | Saídas: ${totalSaidas}</strong></span>
                `;
                details.appendChild(totalElement);
                
                // Evento para expandir/recolher
                header.addEventListener('click', function(e) {
                    if (!e.target.closest('.edit-paletes-report')) {
                        const isVisible = details.style.display !== 'none';
                        details.style.display = isVisible ? 'none' : 'block';
                        this.querySelector('i.bi-chevron-down, i.bi-chevron-up').className = isVisible ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
                    }
                });
                
                // Evento para editar relatório (apenas admin)
                if (userRole === 'admin') {
                    header.querySelector('.edit-paletes-report').addEventListener('click', function(e) {
                        e.stopPropagation();
                        const reportId = this.getAttribute('data-id');
                        editPaletesReport(reportId);
                    });
                }
                
                // Eventos para editar itens (apenas admin)
                if (userRole === 'admin') {
                    details.querySelectorAll('.edit-paletes-item').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const reportId = this.getAttribute('data-report-id');
                            const itemIndex = this.getAttribute('data-item-index');
                            editPaletesItem(reportId, itemIndex);
                        });
                    });
                }
                
                reportElement.appendChild(header);
                reportElement.appendChild(details);
                container.appendChild(reportElement);
            });
        }

        // Função para editar relatório de paletes
        async function editPaletesReport(reportId) {
            let paletesData;
            
            if (useOnlineStorage) {
                paletesData = await loadDataOnline('paletesData') || [];
            } else {
                paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            }
            
            const report = paletesData.find(r => r.id == reportId);
            if (!report) return;
            
            // Preencher formulário de edição
            document.getElementById('edit-paletes-date').value = report.date;
            
            // Mostrar modal de edição
            const modal = new bootstrap.Modal(document.getElementById('editPaletesModal'));
            modal.show();
            
            // Configurar evento de atualização
            document.getElementById('update-paletes-item').onclick = function() {
                const newDate = document.getElementById('edit-paletes-date').value;
                
                if (!newDate) {
                    alert('Por favor, preencha a data!');
                    return;
                }
                
                // Atualizar data do relatório
                report.date = newDate;
                
                // Salvar dados
                if (useOnlineStorage) {
                    saveDataOnline('paletesData', paletesData);
                } else {
                    localStorage.setItem('paletesData', JSON.stringify(paletesData));
                }
                
                // Recarregar dados
                loadPaletesData();
                modal.hide();
                alert('Relatório atualizado com sucesso!');
            };
        }

        // Função para editar item de paletes
        async function editPaletesItem(reportId, itemIndex) {
            let paletesData;
            
            if (useOnlineStorage) {
                paletesData = await loadDataOnline('paletesData') || [];
            } else {
                paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            }
            
            const report = paletesData.find(r => r.id == reportId);
            if (!report || !report.items[itemIndex]) return;
            
            const item = report.items[itemIndex];
            
            // Preencher formulário de edição
            document.getElementById('edit-paletes-date').value = report.date;
            document.getElementById('edit-paletes-type').value = item.type;
            document.getElementById('edit-paletes-movement').value = item.movement;
            document.getElementById('edit-paletes-quantity').value = item.quantity;
            document.getElementById('edit-paletes-id').value = reportId;
            
            // Mostrar modal de edição
            const modal = new bootstrap.Modal(document.getElementById('editPaletesModal'));
            modal.show();
            
            // Configurar evento de atualização
            document.getElementById('update-paletes-item').onclick = function() {
                const newDate = document.getElementById('edit-paletes-date').value;
                const newType = document.getElementById('edit-paletes-type').value;
                const newMovement = document.getElementById('edit-paletes-movement').value;
                const newQuantity = document.getElementById('edit-paletes-quantity').value;
                
                if (!newDate || !newType || !newMovement || !newQuantity) {
                    alert('Por favor, preencha todos os campos!');
                    return;
                }
                
                // Atualizar item
                item.type = newType;
                item.movement = newMovement;
                item.quantity = parseInt(newQuantity);
                report.date = newDate;
                
                // Salvar dados
                if (useOnlineStorage) {
                    saveDataOnline('paletesData', paletesData);
                } else {
                    localStorage.setItem('paletesData', JSON.stringify(paletesData));
                }
                
                // Recarregar dados
                loadPaletesData();
                modal.hide();
                alert('Item atualizado com sucesso!');
            };
        }

        // Função para adicionar item de paletes
        async function addPaletesItem() {
            const date = document.getElementById('paletes-date').value;
            const type = document.getElementById('paletes-type').value;
            const movement = document.getElementById('paletes-movement').value;
            const quantity = parseInt(document.getElementById('paletes-quantity').value);
            
            if (!date || !type || !movement || !quantity) {
                alert('Por favor, preencha todos os campos!');
                return;
            }
            
            let paletesData;
            
            if (useOnlineStorage) {
                paletesData = await loadDataOnline('paletesData') || [];
            } else {
                paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            }
            
            // Verificar se já existe um relatório para esta data
            let existingReport = paletesData.find(r => r.date === date);
            
            if (!existingReport) {
                // Criar novo relatório
                const reportNumber = getNextPaletesReportNumber();
                existingReport = {
                    id: Date.now(),
                    date: date,
                    reportNumber: reportNumber,
                    items: []
                };
                paletesData.push(existingReport);
            }
            
            // Adicionar item ao relatório
            existingReport.items.push({
                type: type,
                movement: movement,
                quantity: quantity
            });
            
            // Salvar dados
            if (useOnlineStorage) {
                await saveDataOnline('paletesData', paletesData);
            } else {
                localStorage.setItem('paletesData', JSON.stringify(paletesData));
            }
            
            // Recarregar a exibição
            loadPaletesData();
            
            // Limpar formulário
            document.getElementById('paletes-form').reset();
            document.getElementById('paletes-date').value = date;
            document.getElementById('paletes-quantity').value = '1';
            
            alert('Movimentação de paletes adicionada com sucesso!');
        }

        // Função para obter o próximo número de relatório de paletes
        function getNextPaletesReportNumber() {
            let reportNumber = parseInt(localStorage.getItem('lastPaletesReportNumber') || '0');
            reportNumber++;
            localStorage.setItem('lastPaletesReportNumber', reportNumber.toString());
            return reportNumber;
        }

        // Função para gerar PDF de paletes (ATUALIZADA)
        async function generatePaletesPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título do relatório
            doc.setFontSize(18);
            doc.text('RELATÓRIO DE MOVIMENTAÇÃO DE PALETES', 14, 15);
            doc.setFontSize(12);
            doc.text(`Data de geração: ${new Date().toLocaleDateString('pt-BR')}`, 14, 25);
            
            // Obter dados com filtro aplicado
            const filterDate = document.getElementById('paletes-filter-date').value;
            let paletesData;
            
            if (useOnlineStorage) {
                paletesData = await loadDataOnline('paletesData') || [];
            } else {
                paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            }
            
            // Aplicar filtro de data se existir
            if (filterDate) {
                paletesData = paletesData.filter(report => report.date === filterDate);
            }
            
            if (paletesData.length === 0) {
                doc.text('Nenhum dado de movimentação de paletes encontrado.', 14, 40);
                doc.save('relatorio_paletes.pdf');
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            paletesData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let yPosition = 40;
            
            paletesData.forEach(report => {
                // Verificar se precisa de nova página
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Cabeçalho do relatório
                doc.setFontSize(14);
                doc.text(`Relatório Diário - Nº ${report.reportNumber.toString().padStart(6, '0')}`, 14, yPosition);
                yPosition += 7;
                
                doc.setFontSize(12);
                doc.text(`Data: ${formatDate(report.date)}`, 14, yPosition);
                yPosition += 7;
                doc.text(`Emissão: ${formatDate(report.date)} ${new Date().toLocaleTimeString('pt-BR')}`, 14, yPosition);
                yPosition += 10;
                
                // Seção de movimentação de paletes
                doc.setFontSize(12);
                doc.text('MOVIMENTAÇÃO DE PALETES', 14, yPosition);
                yPosition += 7;
                
                // Calcular totais
                let totalEntradas = 0;
                let totalSaidas = 0;
                
                // Detalhes das movimentações
                report.items.forEach(item => {
                    doc.text(`  ${item.type} - ${item.movement}: ${item.quantity} paletes`, 20, yPosition);
                    yPosition += 6;
                    
                    // Calcular totais
                    if (item.movement === 'Entrada') {
                        totalEntradas += item.quantity;
                    } else {
                        totalSaidas += item.quantity;
                    }
                });
                
                // Adicionar linha de totais
                yPosition += 5;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`TOTAIS: Entradas: ${totalEntradas} | Saídas: ${totalSaidas}`, 20, yPosition);
                doc.setFont(undefined, 'normal');
                
                yPosition += 15;
            });
            
            // Adicionar créditos no final do PDF
            if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
            }
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Relatório de Movientação BlueWay', 14, yPosition);
            
            doc.save('relatorio_paletes.pdf');
            alert('PDF de movimentação de paletes gerado com sucesso!');
        }

        // Função para exportar Excel de paletes (ATUALIZADA)
        async function generatePaletesExcel() {
            const filterDate = document.getElementById('paletes-filter-date').value;
            let paletesData;
            
            if (useOnlineStorage) {
                paletesData = await loadDataOnline('paletesData') || [];
            } else {
                paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            }
            
            // Aplicar filtro de data se existir
            if (filterDate) {
                paletesData = paletesData.filter(report => report.date === filterDate);
            }
            
            if (paletesData.length === 0) {
                alert('Nenhum dado de movimentação de paletes encontrado!');
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            paletesData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Preparar dados para a planilha
            const data = [];
            
            // Cabeçalho
            data.push(['Relatório', 'Data', 'Tipo de Palete', 'Movimentação', 'Quantidade']);
            
            // Dados
            paletesData.forEach(report => {
                report.items.forEach(item => {
                    data.push([
                        `Nº ${report.reportNumber.toString().padStart(6, '0')}`,
                        formatDate(report.date),
                        item.type,
                        item.movement,
                        item.quantity
                    ]);
                });
            });
            
            // Adicionar linha de créditos
            data.push([]);
            data.push(['Sistema de Movimentação BLUEWAY']);
            
            // Criar planilha
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Movimentação de Paletes');
            
            // Salvar arquivo
            XLSX.writeFile(wb, 'movimentacao_paletes.xlsx');
            alert('Excel de movimentação de paletes exportado com sucesso!');
        }

        // Função para exportar produtos para Excel
        async function exportProductsExcel() {
            let productsData;
            
            if (useOnlineStorage) {
                productsData = await loadDataOnline('productsData') || [];
            } else {
                productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            }
            
            if (productsData.length === 0) {
                alert('Nenhum produto encontrado!');
                return;
            }
            
            // Preparar dados para a planilha
            const data = [];
            
            // Cabeçalho
            data.push(['SKU', 'Produto', 'Tipo', 'Quantidade', 'Lote', 'Data Fabricação', 'Status']);
            
            // Dados
            productsData.forEach(product => {
                const expiryDate = calculateExpiryDate(product['Data Fabricação']);
                const status = checkProductStatus(expiryDate);
                
                data.push([
                    product.SKU,
                    product.Produto,
                    product.Tipo,
                    product.Quantidade,
                    product.Lote,
                    formatDate(product['Data Fabricação']),
                    status.status
                ]);
            });
            
            // Adicionar linha de créditos
            data.push([]);
            data.push(['Sistema de Movimentação BLUEWAY']);
            
            // Criar planilha
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Estoque de Produtos');
            
            // Salvar arquivo
            XLSX.writeFile(wb, 'estoque_produtos.xlsx');
            alert('Excel de produtos exportado com sucesso!');
        }

        // Função para gerar PDF de estoque
        async function generateStockPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título do relatório
            doc.setFontSize(18);
            doc.text('Relatório de Estoque', 14, 15);
            doc.setFontSize(12);
            doc.text(`Data de geração: ${new Date().toLocaleDateString('pt-BR')}`, 14, 25);
            
            // Obter dados filtrados
            const filteredData = await getFilteredStockData();
            
            if (filteredData.length === 0) {
                doc.text('Nenhum dado encontrado para o filtro aplicado.', 14, 40);
                doc.save('relatorio_estoque.pdf');
                return;
            }
            
            // Tabela com os dados
            const tableData = filteredData.map(item => {
                return [
                    item.date,
                    item.movementType,
                    item.productName,
                    item.quantity,
                    item.productType,
                    item.batch,
                    formatDate(item.manufacturingDate)
                ];
            });
            
            doc.autoTable({
                startY: 35,
                head: [['Data', 'Movimento', 'Produto', 'Quantidade', 'Tipo', 'Lote', 'Fabrição']],
                body: tableData,
                theme: 'grid'
            });
            
            // Adicionar créditos no final do PDF
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Movimentação BlueWay', 14, finalY);
            
            // Salvar o PDF
            doc.save('relatorio_estoque.pdf');
            alert('Relatório de estoque exportado com sucesso!');
        }

        // Função para gerar Excel de estoque
        async function generateStockExcel() {
            const filteredData = await getFilteredStockData();
            
            if (filteredData.length === 0) {
                alert('Nenhum dado encontrado para o filtro aplicado!');
                return;
            }
            
            // Preparar dados para a planilha
            const data = [];
            
            // Cabeçalho
            data.push(['Data', 'Movimento', 'Produto', 'Quantidade', 'Tipo', 'Lote', 'Data Fabricação']);
            
            // Dados
            filteredData.forEach(item => {
                data.push([
                    item.date,
                    item.movementType,
                    item.productName,
                    item.quantity,
                    item.productType,
                    item.batch,
                    formatDate(item.manufacturingDate)
                ]);
            });
            
            // Adicionar linha de créditos
            data.push([]);
            data.push(['Sistema de Movimentação BLUEWAY']);
            
            // Criar planilha
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Movimentações');
            
            // Salvar arquivo
            XLSX.writeFile(wb, 'relatorio_estoque.xlsx');
            alert('Excel de estoque exportado com sucesso!');
        }

        // Função para obter o próximo número de relatório
        function getNextReportNumber() {
            let reportNumber = parseInt(localStorage.getItem('lastReportNumber') || '0');
            reportNumber++;
            localStorage.setItem('lastReportNumber', reportNumber.toString());
            return reportNumber;
        }

        // Função para carregar produtos para a tela de movimentação
        async function loadProductsForMovement() {
            const productSelect = document.getElementById('input-product');
            productSelect.innerHTML = '<option value="">Selecione um produto</option>';
            
            // Obter produtos do estoque
            let productsData;
            
            if (useOnlineStorage) {
                productsData = await loadDataOnline('productsData') || [];
            } else {
                productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            }
            
            // Criar lista única de produtos (agrupando por SKU)
            const uniqueProducts = {};
            productsData.forEach(product => {
                if (!uniqueProducts[product.SKU]) {
                    uniqueProducts[product.SKU] = {
                        SKU: product.SKU,
                        Produto: product.Produto,
                        Tipo: product.Tipo
                    };
                }
            });
            
            // Adicionar opções ao select
            Object.values(uniqueProducts).forEach(product => {
                const option = document.createElement('option');
                option.value = product.SKU;
                option.textContent = `${product.SKU} - ${product.Produto} (${product.Tipo})`;
                option.setAttribute('data-type', product.Tipo);
                productSelect.appendChild(option);
            });
        }

        // Função para atualizar detalhes do produto na movimentação
        function updateProductDetails() {
            const productSelect = document.getElementById('input-product');
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const typeInput = document.getElementById('input-productType');
            
            if (selectedOption.value) {
                typeInput.value = selectedOption.getAttribute('data-type');
            } else {
                typeInput.value = '';
            }
        }

        // Função para carregar lotes para o produto selecionado
        async function loadLotesForProduct() {
            const productSKU = document.getElementById('input-product').value;
            const movementType = document.getElementById('input-movementType').value;
            const batchSelect = document.getElementById('input-batch');
            const loteInfo = document.getElementById('lote-info');
            const manufacturingDateInput = document.getElementById('input-manufacturingDate');
            
            batchSelect.innerHTML = '<option value="">Selecione um lote</option>';
            loteInfo.innerHTML = '';
            manufacturingDateInput.value = '';
            
            if (!productSKU) return;
            
            // Obter produtos do estoque
            let productsData;
            
            if (useOnlineStorage) {
                productsData = await loadDataOnline('productsData') || [];
            } else {
                productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            }
            
            if (movementType === 'Entrada') {
                // Para entrada, permitir novo lote ou lote existente
                batchSelect.innerHTML += '<option value="**NOVO_LOTE**">++ Novo Lote ++</option>';
                
                // Agrupar lotes existentes por lote
                const lotesExistentes = {};
                productsData.filter(p => p.SKU === productSKU).forEach(product => {
                    const lote = product.Lote || 'Sem Lote';
                    if (!lotesExistentes[lote]) {
                        lotesExistentes[lote] = {
                            lote: lote,
                            quantidade: 0,
                            fabricacao: product['Data Fabricação']
                        };
                    }
                    lotesExistentes[lote].quantidade += product.Quantidade;
                });
                
                // Adicionar lotes existentes
                Object.values(lotesExistentes).forEach(lote => {
                    const option = document.createElement('option');
                    option.value = lote.lote;
                    option.textContent = `${lote.lote} (${lote.quantidade} disponíveis)`;
                    option.setAttribute('data-fabricacao', lote.fabricacao);
                    batchSelect.appendChild(option);
                });
                
                loteInfo.innerHTML = 'Para entrada, selecione um lote existente ou crie um novo.';
                
            } else if (movementType === 'Saída' || movementType === 'Devolução') {
                // Para saída, mostrar apenas lotes com quantidade disponível
                const lotesDisponiveis = productsData.filter(p => 
                    p.SKU === productSKU && p.Quantidade > 0
                );
                
                if (lotesDisponiveis.length === 0) {
                    batchSelect.innerHTML = '<option value="">Nenhum lote disponível</option>';
                    loteInfo.innerHTML = '<span class="text-danger">Nenhum lote disponível para este produto.</span>';
                    return;
                }
                
                // Ordenar por data de fabricação (FIFO)
                lotesDisponiveis.sort((a, b) => new Date(a['Data Fabricação']) - new Date(b['Data Fabricação']));
                
                // Agrupar por lote
                const lotesAgrupados = {};
                lotesDisponiveis.forEach(product => {
                    const lote = product.Lote || 'Sem Lote';
                    if (!lotesAgrupados[lote]) {
                        lotesAgrupados[lote] = {
                            lote: lote,
                            quantidade: 0,
                            fabricacao: product['Data Fabricação'],
                            produtos: []
                        };
                    }
                    lotesAgrupados[lote].quantidade += product.Quantidade;
                    lotesAgrupados[lote].produtos.push(product);
                });
                
                // Adicionar opções
                Object.values(lotesAgrupados).forEach(lote => {
                    const option = document.createElement('option');
                    option.value = lote.lote;
                    option.textContent = `${lote.lote} (${lote.quantidade} disponíveis)`;
                    option.setAttribute('data-fabricacao', lote.fabricacao);
                    option.setAttribute('data-produtos', JSON.stringify(lote.produtos));
                    batchSelect.appendChild(option);
                });
                
                loteInfo.innerHTML = 'Para saída, o sistema usará o método FIFO (primeiro a entrar, primeiro a sair).';
            }
            
            // Event listener para quando o lote é selecionado
            batchSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value && selectedOption.getAttribute('data-fabricacao')) {
                    manufacturingDateInput.value = selectedOption.getAttribute('data-fabricacao');
                } else {
                    manufacturingDateInput.value = '';
                }
            });
        }

        // Função para adicionar novo produto
        async function addNewProduct() {
            const sku = document.getElementById('new-product-sku').value;
            const product = document.getElementById('new-product-name').value;
            const type = document.getElementById('new-product-type').value;
            const quantity = document.getElementById('new-product-quantity').value;
            const batch = document.getElementById('new-product-batch').value;
            const manufacturingDate = document.getElementById('new-product-manufacturing-date').value;
            
            // Validar campos obrigatórios
            if (!sku || !product || !type || !quantity || !manufacturingDate) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            // Obter produtos existentes
            let productsData;
            
            if (useOnlineStorage) {
                productsData = await loadDataOnline('productsData') || [];
            } else {
                productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            }
            
            // Verificar se já existe um produto com o mesmo SKU e lote
            const existingProductIndex = productsData.findIndex(p => 
                p.SKU === sku && p.Lote === (batch || 'Sem Lote')
            );
            
            if (existingProductIndex !== -1) {
                // Atualizar quantidade do produto existente
                productsData[existingProductIndex].Quantidade += parseInt(quantity);
                productsData[existingProductIndex].Entradas += parseInt(quantity);
            } else {
                // Adicionar novo produto
                productsData.push({
                    SKU: sku,
                    Produto: product,
                    Tipo: type,
                    Quantidade: parseInt(quantity),
                    Lote: batch || 'Sem Lote',
                    'Data Fabricação': manufacturingDate,
                    Entradas: parseInt(quantity),
                    Saídas: 0,
                    id: Date.now() // ID único para cada item
                });
            }
            
            // Salvar dados
            if (useOnlineStorage) {
                await saveDataOnline('productsData', productsData);
            } else {
                localStorage.setItem('productsData', JSON.stringify(productsData));
            }
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
            modal.hide();
            
            // Recarregar tabela
            loadProductsData();
            
            alert('Produto adicionado com sucesso!');
        }

        // Função para abrir modal de adicionar/editar lote
        function openLoteModal(sku, index = null) {
            // Limpar formulário
            document.getElementById('lote-form').reset();
            
            // Definir SKU
            document.getElementById('lote-sku').value = sku;
            
            // Definir data atual como padrão
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('lote-manufacturing-date').value = today;
            
            // Configurar modal para edição se um índice for fornecido
            if (index !== null) {
                document.getElementById('loteModalTitle').textContent = 'Editar Lote';
                document.getElementById('lote-index').value = index;
                
                // Obter dados do lote
                const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
                const lote = productsData[index];
                
                // Preencher formulário com dados existentes
                document.getElementById('lote-quantity').value = lote.Quantidade;
                document.getElementById('lote-batch').value = lote.Lote === 'Sem Lote' ? '' : lote.Lote;
                document.getElementById('lote-manufacturing-date').value = lote['Data Fabricação'];
            } else {
                document.getElementById('loteModalTitle').textContent = 'Adicionar Lote';
                document.getElementById('lote-index').value = '';
            }
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('loteModal'));
            modal.show();
        }

        // Função para salvar lote (adicionar ou editar)
        async function saveLote() {
            const sku = document.getElementById('lote-sku').value;
            const index = document.getElementById('lote-index').value;
            const quantity = document.getElementById('lote-quantity').value;
            const batch = document.getElementById('lote-batch').value;
            const manufacturingDate = document.getElementById('lote-manufacturing-date').value;
            
            // Validar campos obrigatórios
            if (!quantity || !manufacturingDate) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            // Obter produtos existentes
            let productsData;
            
            if (useOnlineStorage) {
                productsData = await loadDataOnline('productsData') || [];
            } else {
                productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            }
            
            if (index) {
                // Modo de edição - atualizar lote existente
                const loteIndex = parseInt(index);
                if (loteIndex >= 0 && loteIndex < productsData.length) {
                    productsData[loteIndex].Quantidade = parseInt(quantity);
                    productsData[loteIndex].Lote = batch || 'Sem Lote';
                    productsData[loteIndex]['Data Fabricação'] = manufacturingDate;
                }
            } else {
                // Modo de adição - verificar se já existe um lote com o mesmo nome
                const existingLoteIndex = productsData.findIndex(p => 
                    p.SKU === sku && p.Lote === (batch || 'Sem Lote')
                );
                
                if (existingLoteIndex !== -1) {
                    // Atualizar quantidade do lote existente
                    productsData[existingLoteIndex].Quantidade += parseInt(quantity);
                    productsData[existingLoteIndex].Entradas += parseInt(quantity);
                } else {
                    // Encontrar o produto base para copiar informações
                    const baseProduct = productsData.find(p => p.SKU === sku);
                    if (!baseProduct) {
                        alert('Produto não encontrado!');
                        return;
                    }
                    
                    // Adicionar novo lote
                    productsData.push({
                        SKU: sku,
                        Produto: baseProduct.Produto,
                        Tipo: baseProduct.Tipo,
                        Quantidade: parseInt(quantity),
                        Lote: batch || 'Sem Lote',
                        'Data Fabricação': manufacturingDate,
                        Entradas: parseInt(quantity),
                        Saídas: 0,
                        id: Date.now() // ID único para cada item
                    });
                }
            }
            
            // Salvar dados
            if (useOnlineStorage) {
                await saveDataOnline('productsData', productsData);
            } else {
                localStorage.setItem('productsData', JSON.stringify(productsData));
            }
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('loteModal'));
            modal.hide();
            
            // Recarregar tabela
            loadProductsData();
            
            alert(index ? 'Lote atualizado com sucesso!' : 'Lote adicionado com sucesso!');
        }

        // Função para editar produto
        function editProduct(index) {
            // Obter produtos do localStorage
            const productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            if (index >= 0 && index < productsData.length) {
                const product = productsData[index];
                
                // Preencher formulário de edição
                document.getElementById('edit-product-index').value = index;
                document.getElementById('edit-product-sku').value = product.SKU;
                document.getElementById('edit-product-name').value = product.Produto;
                document.getElementById('edit-product-type').value = product.Tipo;
                document.getElementById('edit-product-quantity').value = product.Quantidade;
                document.getElementById('edit-product-batch').value = product.Lote === 'Sem Lote' ? '' : product.Lote;
                document.getElementById('edit-product-manufacturing-date').value = product['Data Fabricação'];
                
                // Mostrar modal de edição
                const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
                modal.show();
            }
        }

        // Função para atualizar produto
        async function updateProduct() {
            const index = document.getElementById('edit-product-index').value;
            const sku = document.getElementById('edit-product-sku').value;
            const product = document.getElementById('edit-product-name').value;
            const type = document.getElementById('edit-product-type').value;
            const quantity = document.getElementById('edit-product-quantity').value;
            const batch = document.getElementById('edit-product-batch').value;
            const manufacturingDate = document.getElementById('edit-product-manufacturing-date').value;
            
            // Validar campos obrigatórios
            if (!sku || !product || !type || !quantity || !manufacturingDate) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            // Obter produtos
            let productsData;
            
            if (useOnlineStorage) {
                productsData = await loadDataOnline('productsData') || [];
            } else {
                productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            }
            
            if (index >= 0 && index < productsData.length) {
                // Atualizar produto
                productsData[index] = {
                    ...productsData[index],
                    SKU: sku,
                    Produto: product,
                    Tipo: type,
                    Quantidade: parseInt(quantity),
                    Lote: batch || 'Sem Lote',
                    'Data Fabricação': manufacturingDate
                };
                
                // Salvar dados
                if (useOnlineStorage) {
                    await saveDataOnline('productsData', productsData);
                } else {
                    localStorage.setItem('productsData', JSON.stringify(productsData));
                }
                
                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
                modal.hide();
                
                // Recarregar tabela
                loadProductsData();
                
                alert('Produto atualizado com sucesso!');
            }
        }

        // Função para excluir produto
        async function deleteProduct(index) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                // Obter produtos
                let productsData;
                
                if (useOnlineStorage) {
                    productsData = await loadDataOnline('productsData') || [];
                } else {
                    productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
                }
                
                if (index >= 0 && index < productsData.length) {
                    // Remover produto
                    productsData.splice(index, 1);
                    
                    // Salvar dados
                    if (useOnlineStorage) {
                        await saveDataOnline('productsData', productsData);
                    } else {
                        localStorage.setItem('productsData', JSON.stringify(productsData));
                    }
                    
                    // Recarregar tabela
                    loadProductsData();
                    
                    alert('Produto excluído com sucesso!');
                }
            }
        }

        // Função para adicionar item à tabela (tela de movimentação)
        function addItemToTable() {
            // Obter valores dos campos
            const date = document.getElementById('input-date').value;
            const movementType = document.getElementById('input-movementType').value;
            const productSelect = document.getElementById('input-product');
            const productSKU = productSelect.value;
            const productText = productSelect.options[productSelect.selectedIndex].text;
            const quantity = parseInt(document.getElementById('input-quantity').value);
            const productType = document.getElementById('input-productType').value;
            const batchSelect = document.getElementById('input-batch');
            const batch = batchSelect.value;
            const manufacturingDate = document.getElementById('input-manufacturingDate').value;
            
            // Validar campos
            if (!date || !productSKU || !quantity || !batch) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            // Validar quantidade para saída
            if (movementType === 'Saída' || movementType === 'Devolução') {
                const availableQuantity = getAvailableQuantity(productSKU, batch);
                if (quantity > availableQuantity) {
                    alert(`Quantidade indisponível! Disponível: ${availableQuantity}`);
                    return;
                }
            }
            
            // Extrair nome do produto do texto do option
            const productName = productText.split(' - ')[1].split(' (')[0];
            
            // Adicionar produto à lista
            const productData = {
                date,
                movementType,
                productSKU,
                productName,
                quantity: quantity,
                productType,
                batch: batch === '**NOVO_LOTE**' ? 'Novo Lote' : batch,
                manufacturingDate,
                availableQuantity: movementType === 'Entrada' ? quantity : getAvailableQuantity(productSKU, batch)
            };
            
            productsList.push(productData);
            
            // Atualizar a tabela
            updateProductsTable();
            
            // Limpar o formulário (exceto data e tipo de movimento)
            document.getElementById('input-product').value = '';
            document.getElementById('input-quantity').value = '1';
            document.getElementById('input-batch').innerHTML = '<option value="">Selecione um lote</option>';
            document.getElementById('input-productType').value = '';
            document.getElementById('input-manufacturingDate').value = '';
            document.getElementById('lote-info').innerHTML = '';
            
            // Focar no campo de produto para próxima entrada
            document.getElementById('input-product').focus();
            
            // Mostrar mensagem de sucesso
            alert('Produto adicionado à tabela!');
        }

        // Função para obter quantidade disponível de um lote
        async function getAvailableQuantity(productSKU, batch) {
            let productsData;
            
            if (useOnlineStorage) {
                productsData = await loadDataOnline('productsData') || [];
            } else {
                productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            }
            
            const lotes = productsData.filter(p => p.SKU === productSKU && p.Lote === batch && p.Quantidade > 0);
            return lotes.reduce((total, p) => total + p.Quantidade, 0);
        }

        function updateProductsTable() {
            const tableBody = document.getElementById('products-table-body');
            const tableContainer = document.getElementById('products-table-container');
            
            tableBody.innerHTML = '';
            
            if (productsList.length === 0) {
                tableContainer.style.display = 'none';
                return;
            }
            
            tableContainer.style.display = 'block';
            
            productsList.forEach((product, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.date}</td>
                    <td>${product.movementType}</td>
                    <td>${product.productName}</td>
                    <td>${product.quantity}</td>
                    <td>${product.productType}</td>
                    <td>${product.batch}</td>
                    <td>${formatDate(product.manufacturingDate)}</td>
                    <td>${product.availableQuantity}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-warning table-action-btn edit-product" data-index="${index}" title="Alterar item">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger table-action-btn remove-product" data-index="${index}" title="Remover item">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Adicionar eventos aos botões de remover
            document.querySelectorAll('.remove-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    productsList.splice(index, 1);
                    updateProductsTable();
                    updateSummary();
                });
            });
            
            updateSummary();
        }

        function updateSummary() {
            let totalItems = productsList.length;
            let totalQuantity = 0;
            let entradaCount = 0;
            let saidaCount = 0;
            let devolucaoCount = 0;
            
            productsList.forEach(product => {
                totalQuantity += product.quantity;
                
                if (product.movementType === 'Entrada') {
                    entradaCount += product.quantity;
                } else if (product.movementType === 'Saída') {
                    saidaCount += product.quantity;
                } else if (product.movementType === 'Devolução') {
                    devolucaoCount += product.quantity;
                }
            });
            
            // Atualizar resumo
            const summaryText = document.getElementById('summary-text');
            if (totalItems === 0) {
                summaryText.textContent = 'Nenhum item adicionado ainda';
            } else {
                summaryText.innerHTML = `
                    <strong>Total de itens:</strong> ${totalItems} | 
                    <strong>Quantidade total:</strong> ${totalQuantity} |
                    <strong>Entradas:</strong> ${entradaCount} |
                    <strong>Saídas:</strong> ${saidaCount} |
                    <strong>Devoluções:</strong> ${devolucaoCount}
                `;
            }
        }

        // Função para gerar PDF e salvar relatório (ATUALIZADA - com fotos)
        async function generatePDF() {
            if (productsList.length === 0) {
                alert('Adicione pelo menos um produto à tabela antes de gerar o PDF!');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Obter número do relatório
            const reportNumber = getNextReportNumber();
            const reportDate = document.getElementById('input-date').value;
            
            // Título do relatório
            doc.setFontSize(18);
            doc.text(`Relatório de Movimentação #${reportNumber}`, 14, 15);
            doc.setFontSize(12);
            doc.text(`Data: ${formatDate(reportDate)}`, 14, 22);
            doc.text(`Data de geração: ${new Date().toLocaleDateString()}`, 14, 28);
            
            // Tabela com os dados
            const tableData = productsList.map(product => [
                product.date,
                product.movementType,
                product.productName,
                product.quantity,
                product.productType,
                product.batch,
                formatDate(product.manufacturingDate),
                product.availableQuantity
            ]);
            
            doc.autoTable({
                startY: 35,
                head: [['Data', 'Movimento', 'Produto', 'Quantidade', 'Tipo', 'Lote', 'Fabrição', 'Disponível']],
                body: tableData,
                theme: 'grid'
            });
            
            // Adicionar fotos ao PDF se houver
            if (uploadedPhotos.length > 0) {
                let yPosition = doc.lastAutoTable.finalY + 10;
                
                doc.setFontSize(14);
                doc.text('Fotos:', 14, yPosition);
                yPosition += 10;
                
                uploadedPhotos.forEach((photo, index) => {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    try {
                        doc.addImage(photo.data, 'JPEG', 14, yPosition, 40, 40);
                        yPosition += 45;
                    } catch (e) {
                        console.error('Erro ao adicionar imagem ao PDF:', e);
                    }
                });
            }
            
            // Adicionar créditos no final do PDF
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text('Sistema de Movimentação BLUEWAY', 14, finalY);
            
            // Salvar o PDF
            const fileName = `relatorio_movimentacao_${reportNumber}_${reportDate}.pdf`;
            doc.save(fileName);
            
            // Salvar relatório no histórico (com fotos)
            await saveReportToHistory(reportNumber, reportDate);
            
            // Atualizar estoque com os produtos movimentados
            await updateStockFromMovement();
            
            alert(`PDF gerado com sucesso! Relatório #${reportNumber} salvo.`);
        }

        // Função para salvar relatório no histórico (ATUALIZADA - com fotos)
        async function saveReportToHistory(reportNumber, reportDate) {
            let reportsHistory;
            
            if (useOnlineStorage) {
                reportsHistory = await loadDataOnline('reportsHistory') || [];
            } else {
                reportsHistory = JSON.parse(localStorage.getItem('reportsHistory') || '[]');
            }
            
            const report = {
                reportNumber: reportNumber,
                date: reportDate,
                timestamp: new Date().toISOString(),
                items: [...productsList], // Copia os itens do relatório
                photos: [...uploadedPhotos] // Salva as fotos
            };
            
            reportsHistory.push(report);
            
            // Salvar dados
            if (useOnlineStorage) {
                await saveDataOnline('reportsHistory', reportsHistory);
            } else {
                localStorage.setItem('reportsHistory', JSON.stringify(reportsHistory));
            }
            
            // Limpar fotos após salvar
            uploadedPhotos = [];
            document.getElementById('photo-previews').innerHTML = '';
            document.getElementById('photos').value = '';
        }

        // Função para carregar dados dos produtos (com agrupamento)
        async function loadProductsData() {
            const skuFilter = document.getElementById('products-filter-sku').value;
            const productFilter = document.getElementById('products-filter-name').value;
            const typeFilter = document.getElementById('products-filter-type').value;
            
            // Obter dados
            let productsData;
            
            if (useOnlineStorage) {
                productsData = await loadDataOnline('productsData') || [];
            } else {
                productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            }
            
            // Se não houver dados, usar dados de exemplo
            if (productsData.length === 0) {
                productsData = [
                    { 
                        SKU: "PROD001", 
                        Produto: "Produto A", 
                        Tipo: "Tambor", 
                        Quantidade: 50,
                        Lote: "LOTE-001",
                        'Data Fabricação': "2022-05-15",
                        Entradas: 50,
                        Saídas: 0,
                        id: 1
                    }
                ];
                if (useOnlineStorage) {
                    await saveDataOnline('productsData', productsData);
                } else {
                    localStorage.setItem('productsData', JSON.stringify(productsData));
                }
            }
            
            // Filtrar dados
            const filteredData = productsData.filter(item => {
                return (!skuFilter || item.SKU.toLowerCase().includes(skuFilter.toLowerCase())) &&
                       (!productFilter || item.Produto.toLowerCase().includes(productFilter.toLowerCase())) &&
                       (!typeFilter || item.Tipo === typeFilter);
            });
            
            // Agrupar produtos por SKU
            const groupedProducts = {};
            filteredData.forEach(item => {
                if (!groupedProducts[item.SKU]) {
                    groupedProducts[item.SKU] = {
                        SKU: item.SKU,
                        Produto: item.Produto,
                        Tipo: item.Tipo,
                        QuantidadeTotal: 0,
                        Lotes: [],
                        expanded: localStorage.getItem(`expanded_${item.SKU}`) === 'true'
                    };
                }
                groupedProducts[item.SKU].QuantidadeTotal += item.Quantidade;
                groupedProducts[item.SKU].Lotes.push(item);
            });
            
            // Atualizar tabela
            const tbody = document.getElementById('products-list');
            tbody.innerHTML = '';
            
            if (Object.keys(groupedProducts).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum resultado encontrado</td></tr>';
                return;
            }
            
            // Adicionar produtos agrupados à tabela
            Object.values(groupedProducts).forEach(group => {
                // Linha do grupo (cabeçalho)
                const groupRow = document.createElement('tr');
                groupRow.className = 'product-group';
                groupRow.setAttribute('data-sku', group.SKU);
                groupRow.innerHTML = `
                    <td>${group.SKU}</td>
                    <td>${group.Produto}</td>
                    <td>${group.Tipo}</td>
                    <td>${group.QuantidadeTotal}</td>
                    <td>
                        ${group.Lotes.length} lote(s)
                        ${group.Lotes.length > 1 ? '<span class="batch-indicator">' + group.Lotes.length + '</span>' : ''}
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary toggle-details" data-sku="${group.SKU}" title="${group.expanded ? 'Recolher' : 'Expandir'}">
                            <i class="bi ${group.expanded ? 'bi-dash' : 'bi-plus'}"></i>
                        </button>
                        <button class="btn btn-sm btn-success add-lote-btn" data-sku="${group.SKU}" title="Adicionar lote">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(groupRow);
                
                // Adicionar evento de clique para expandir/recolher
                groupRow.addEventListener('click', function(e) {
                    if (!e.target.closest('.toggle-details') && !e.target.closest('.add-lote-btn')) {
                        const sku = this.getAttribute('data-sku');
                        toggleProductDetails(sku);
                    }
                });
                
                // Adicionar evento ao botão de toggle
                groupRow.querySelector('.toggle-details').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const sku = this.getAttribute('data-sku');
                    toggleProductDetails(sku);
                });
                
                // Adicionar evento ao botão de adicionar lote
                groupRow.querySelector('.add-lote-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const sku = this.getAttribute('data-sku');
                    openLoteModal(sku);
                });
                
                // Linhas de detalhes (lotes) - se expandido
                if (group.expanded) {
                    // Ordenar lotes por data de fabricação
                    group.Lotes.sort((a, b) => new Date(a['Data Fabricação']) - new Date(b['Data Fabricação']));
                    
                    group.Lotes.forEach((lote, loteIndex) => {
                        // Calcular data de vencimento (4 anos após a fabricação)
                        const expiryDate = calculateExpiryDate(lote['Data Fabricação']);
                        
                        // Verificar status do produto
                        const statusInfo = checkProductStatus(expiryDate);
                        
                        const detailRow = document.createElement('tr');
                        detailRow.className = 'product-details';
                        detailRow.setAttribute('data-sku', group.SKU);
                        detailRow.innerHTML = `
                            <td class="batch-details"></td>
                            <td class="batch-details"></td>
                            <td class="batch-details"></td>
                            <td>${lote.Quantidade}</td>
                            <td>${lote.Lote || 'Sem Lote'}</td>
                            <td class="text-center">
                                <span class="${statusInfo.class}">${statusInfo.status}</span>
                                <button class="btn btn-sm btn-warning ms-2 edit-lote-btn" data-index="${productsData.findIndex(p => p.id === lote.id)}" title="Editar lote">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger ms-1 delete-lote-btn" data-index="${productsData.findIndex(p => p.id === lote.id)}" title="Excluir lote">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(detailRow);
                        
                        // Adicionar eventos aos botões de editar e excluir lote
                        detailRow.querySelector('.edit-lote-btn').addEventListener('click', function(e) {
                            e.stopPropagation();
                            const index = parseInt(this.getAttribute('data-index'));
                            openLoteModal(group.SKU, index);
                        });
                        
                        detailRow.querySelector('.delete-lote-btn').addEventListener('click', function(e) {
                            e.stopPropagation();
                            const index = parseInt(this.getAttribute('data-index'));
                            deleteProduct(index);
                        });
                        
                        // Adicionar linha com datas de fabricação e vencimento
                        const dateRow = document.createElement('tr');
                        dateRow.className = 'product-details';
                        dateRow.setAttribute('data-sku', group.SKU);
                        dateRow.innerHTML = `
                            <td class="batch-details" colspan="3"></td>
                            <td colspan="3">
                                <small>
                                    <strong>Fabricação:</strong> ${formatDate(lote['Data Fabricação'])} | 
                                    <strong>Vencimento:</strong> ${formatDate(expiryDate)} |
                                    <strong>Entradas:</strong> ${lote.Entradas} |
                                    <strong>Saídas:</strong> ${lote.Saídas}
                                </small>
                            </td>
                        `;
                        tbody.appendChild(dateRow);
                    });
                }
            });
        }

        // Função para expandir/recolher detalhes do produto
        function toggleProductDetails(sku) {
            // Alternar estado de expansão no localStorage
            const currentState = localStorage.getItem(`expanded_${sku}`) === 'true';
            localStorage.setItem(`expanded_${sku}`, !currentState);
            
            // Recarregar a tabela
            loadProductsData();
        }

        // Função para carregar relatório de estoque (ATUALIZADA - com fotos)
        async function loadStockReport() {
            const dateFilter = document.getElementById('stock-filter-date').value;
            
            // Obter relatórios do histórico
            let reportsHistory;
            
            if (useOnlineStorage) {
                reportsHistory = await loadDataOnline('reportsHistory') || [];
            } else {
                reportsHistory = JSON.parse(localStorage.getItem('reportsHistory') || '[]');
            }
            
            // Se não houver dados, usar dados de exemplo
            if (reportsHistory.length === 0) {
                const today = new Date().toISOString().split('T')[0];
                reportsHistory = [
                    {
                        reportNumber: 1,
                        date: today,
                        timestamp: new Date().toISOString(),
                        items: [
                            {
                                date: today,
                                movementType: 'Entrada',
                                productName: 'Produto A',
                                quantity: 50,
                                productType: 'Tambor',
                                batch: 'LOTE-001',
                                manufacturingDate: '2023-05-15'
                            }
                        ],
                        photos: []
                    }
                ];
                if (useOnlineStorage) {
                    await saveDataOnline('reportsHistory', reportsHistory);
                } else {
                    localStorage.setItem('reportsHistory', JSON.stringify(reportsHistory));
                }
            }
            
            // Filtrar por data se fornecida
            let filteredReports = reportsHistory;
            if (dateFilter) {
                filteredReports = reportsHistory.filter(report => report.date === dateFilter);
            }
            
            // Ordenar por número de relatório (decrescente)
            filteredReports.sort((a, b) => b.reportNumber - a.reportNumber);
            
            // Atualizar tabela
            const tbody = document.getElementById('stock-list');
            tbody.innerHTML = '';
            
            if (filteredReports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum relatório encontrado</td></tr>';
                return;
            }
            
            // Preencher tabela com relatórios
            filteredReports.forEach(report => {
                // Calcular totais por tipo de movimento
                const movimentos = {};
                report.items.forEach(item => {
                    if (!movimentos[item.movementType]) {
                        movimentos[item.movementType] = 0;
                    }
                    movimentos[item.movementType] += item.quantity;
                });
                
                // Criar badges para os movimentos
                const movimentosHTML = Object.entries(movimentos).map(([tipo, quantidade]) => 
                    `<span class="movement-badge movement-${tipo.toLowerCase()}">${tipo}: ${quantidade}</span>`
                ).join(' ');
                
                const row = document.createElement('tr');
                row.className = 'loading-group';
                row.setAttribute('data-report', report.reportNumber);
                row.innerHTML = `
                    <td>#${report.reportNumber}</td>
                    <td>${formatDate(report.date)}</td>
                    <td>${movimentosHTML}</td>
                    <td>${report.items.reduce((total, item) => total + item.quantity, 0)} itens</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary toggle-loading-details" data-report="${report.reportNumber}" title="Expandir/Recolher">
                            <i class="bi bi-plus"></i>
                        </button>
                        ${report.photos && report.photos.length > 0 ? 
                          `<span class="badge bg-info ms-2" title="${report.photos.length} foto(s)"><i class="bi bi-image"></i> ${report.photos.length}</span>` : 
                          ''}
                    </td>
                `;
                tbody.appendChild(row);
                
                // Adicionar evento ao botão de toggle
                row.querySelector('.toggle-loading-details').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const reportNumber = this.getAttribute('data-report');
                    toggleReportDetails(reportNumber);
                });
                
                // Linhas de detalhes - se expandido
                const isExpanded = localStorage.getItem(`expanded_report_${report.reportNumber}`) === 'true';
                if (isExpanded) {
                    report.items.forEach((item, index) => {
                        const detailRow = document.createElement('tr');
                        detailRow.className = 'loading-details';
                        detailRow.setAttribute('data-report', report.reportNumber);
                        detailRow.innerHTML = `
                            <td class="batch-details"></td>
                            <td class="batch-details"></td>
                            <td>
                                <span class="movement-badge movement-${item.movementType.toLowerCase()}">${item.movementType}</span>
                                ${item.productName}
                            </td>
                            <td>${item.quantity}</td>
                            <td class="text-center">${item.batch}</td>
                        `;
                        tbody.appendChild(detailRow);
                    });
                    
                    // Mostrar fotos se existirem
                    if (report.photos && report.photos.length > 0) {
                        const photosRow = document.createElement('tr');
                        photosRow.className = 'loading-details';
                        photosRow.setAttribute('data-report', report.reportNumber);
                        photosRow.innerHTML = `
                            <td class="batch-details" colspan="5">
                                <strong>Fotos do Relatório:</strong>
                                <div class="photo-preview-container mt-2">
                                    ${report.photos.map(photo => 
                                        `<img src="${photo.data}" class="photo-preview" alt="Foto do relatório">`
                                    ).join('')}
                                </div>
                            </td>
                        `;
                        tbody.appendChild(photosRow);
                    }
                    
                    // Atualizar ícone para menos
                    row.querySelector('.toggle-loading-details i').className = 'bi bi-dash';
                }
            });
        }

        // Função para expandir/recolher detalhes do relatório
        function toggleReportDetails(reportNumber) {
            // Alternar estado de expansão no localStorage
            const currentState = localStorage.getItem(`expanded_report_${reportNumber}`) === 'true';
            localStorage.setItem(`expanded_report_${reportNumber}`, !currentState);
            
            // Recarregar a tabela
            loadStockReport();
        }

        // Função para obter dados filtrados do estoque
        async function getFilteredStockData() {
            const dateFilter = document.getElementById('stock-filter-date').value;
            
            // Obter dados do histórico de movimentações
            let movementHistory;
            
            if (useOnlineStorage) {
                movementHistory = await loadDataOnline('movementHistory') || [];
            } else {
                movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            }
            
            // Se não houver dados, usar dados de exemplo
            if (movementHistory.length === 0) {
                const today = new Date().toISOString().split('T')[0];
                movementHistory = [
                    {
                        id: 1,
                        timestamp: new Date().toISOString(),
                        date: today,
                        movementType: 'Entrada',
                        productSKU: 'PROD001',
                        productName: 'Produto A',
                        quantity: 50,
                        productType: 'Tambor',
                        batch: 'LOTE-001',
                        manufacturingDate: '2023-05-15'
                    }
                ];
                if (useOnlineStorage) {
                    await saveDataOnline('movementHistory', movementHistory);
                } else {
                    localStorage.setItem('movementHistory', JSON.stringify(movementHistory));
                }
            }
            
            // Filtrar por data se fornecida
            if (dateFilter) {
                return movementHistory.filter(item => item.date === dateFilter);
            }
            
            return movementHistory;
        }

        // Função para carregar dados do histórico
        async function loadHistoryData() {
            let historyData;
            
            if (useOnlineStorage) {
                historyData = await loadDataOnline('movementHistory') || [];
            } else {
                historyData = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            }
            
            const tbody = document.getElementById('historyTableBody');
            
            tbody.innerHTML = '';
            
            if (historyData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum registro encontrado</td></tr>';
                return;
            }
            
            // Ordenar por data (mais recente primeiro)
            historyData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            historyData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${item.movementType}</td>
                    <td>${item.productName}</td>
                    <td>${item.quantity}</td>
                    <td>${item.batch || 'N/A'}</td>
                    <td>${item.remainingQuantity !== undefined ? item.remainingQuantity : 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Função para filtrar histórico
        function filterHistory(searchTerm) {
            const rows = document.getElementById('historyTableBody').querySelectorAll('tr');
            const term = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(term)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Função para atualizar o estoque com base na movimentação (FIFO)
        async function updateStockFromMovement() {
            // Obter produtos do estoque
            let productsData;
            
            if (useOnlineStorage) {
                productsData = await loadDataOnline('productsData') || [];
            } else {
                productsData = JSON.parse(localStorage.getItem('productsData') || '[]');
            }
            
            // Para cada produto na movimentação, atualizar o estoque
            productsList.forEach(movement => {
                if (movement.movementType === 'Entrada') {
                    // Para entrada, verificar se já existe um lote com o mesmo nome
                    const existingLoteIndex = productsData.findIndex(p => 
                        p.SKU === movement.productSKU && p.Lote === movement.batch
                    );
                    
                    if (existingLoteIndex !== -1) {
                        // Atualizar quantidade do lote existente
                        productsData[existingLoteIndex].Quantidade += movement.quantity;
                        productsData[existingLoteIndex].Entradas += movement.quantity;
                    } else {
                        // Adicionar novo item ao estoque
                        const newProduct = {
                            SKU: movement.productSKU,
                            Produto: movement.productName,
                            Tipo: movement.productType,
                            Quantidade: movement.quantity,
                            Lote: movement.batch,
                            'Data Fabricação': movement.manufacturingDate,
                            Entradas: movement.quantity,
                            Saídas: 0,
                            id: Date.now()
                        };
                        
                        productsData.push(newProduct);
                    }
                    
                    // Salvar no histórico de movimentações
                    saveToMovementHistory(movement, movement.quantity);
                    
                } else if (movement.movementType === 'Saída') {
                    // Para saída, usar método FIFO
                    let remainingQuantity = movement.quantity;
                    const movimentacaoLotes = [];
                    
                    // Ordenar produtos por data de fabricação (mais antigos primeiro)
                    const produtosOrdenados = productsData
                        .filter(p => p.SKU === movement.productSKU && p.Quantidade > 0)
                        .sort((a, b) => new Date(a['Data Fabricação']) - new Date(b['Data Fabricação']));
                    
                    // Processar saída por lote (FIFO)
                    for (let produto of produtosOrdenados) {
                        if (remainingQuantity <= 0) break;
                        
                        const quantidadeDisponivel = produto.Quantidade;
                        const quantidadeUsar = Math.min(remainingQuantity, quantidadeDisponivel);
                        
                        // Registrar movimentação do lote
                        movimentacaoLotes.push({
                            lote: produto.Lote,
                            quantidade: quantidadeUsar,
                            disponivelAntes: quantidadeDisponivel
                        });
                        
                        // Atualizar quantidade no estoque
                        produto.Quantidade -= quantidadeUsar;
                        produto.Saídas += quantidadeUsar;
                        remainingQuantity -= quantidadeUsar;
                    }
                    
                    // Salvar detalhes da movimentação no histórico
                    movement.lotesUtilizados = movimentacaoLotes;
                    movement.remainingQuantity = remainingQuantity;
                    saveToMovementHistory(movement, movement.quantity - remainingQuantity);
                    
                } else if (movement.movementType === 'Devolução') {
                    // Para devolução, similar à entrada mas com registro específico
                    const existingLoteIndex = productsData.findIndex(p => 
                        p.SKU === movement.productSKU && p.Lote === movement.batch
                    );
                    
                    if (existingLoteIndex !== -1) {
                        // Atualizar quantidade do lote existente
                        productsData[existingLoteIndex].Quantidade += movement.quantity;
                        productsData[existingLoteIndex].Entradas += movement.quantity;
                    } else {
                        const newProduct = {
                            SKU: movement.productSKU,
                            Produto: movement.productName,
                            Tipo: movement.productType,
                            Quantidade: movement.quantity,
                            Lote: movement.batch,
                            'Data Fabricação': movement.manufacturingDate,
                            Entradas: movement.quantity,
                            Saídas: 0,
                            id: Date.now(),
                            isDevolucao: true
                        };
                        
                        productsData.push(newProduct);
                    }
                    
                    // Salvar no histórico de movimentações
                    saveToMovementHistory(movement, movement.quantity);
                }
            });
            
            // Remover produtos com quantidade zero
            productsData = productsData.filter(p => p.Quantidade > 0);
            
            // Salvar dados
            if (useOnlineStorage) {
                await saveDataOnline('productsData', productsData);
            } else {
                localStorage.setItem('productsData', JSON.stringify(productsData));
            }
            
            // Limpar lista de produtos da movimentação
            productsList = [];
            updateProductsTable();
            
            // Recarregar estoque se estiver na página de produtos
            if (document.getElementById('products-page').classList.contains('active')) {
                loadProductsData();
            }
            
            // Recarregar relatório de estoque se estiver ativo
            if (document.getElementById('stock-report-page').classList.contains('active')) {
                loadStockReport();
            }
        }

        // Função para salvar movimentação no histórico
        async function saveToMovementHistory(movement, quantidadeProcessada) {
            let movementHistory;
            
            if (useOnlineStorage) {
                movementHistory = await loadDataOnline('movementHistory') || [];
            } else {
                movementHistory = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            }
            
            // Adicionar ID único e timestamp
            movementHistory.push({
                id: Date.now(),
                timestamp: new Date().toISOString(),
                ...movement,
                quantidadeProcessada: quantidadeProcessada,
                remainingQuantity: movement.remainingQuantity || 0
            });
            
            // Salvar dados
            if (useOnlineStorage) {
                await saveDataOnline('movementHistory', movementHistory);
            } else {
                localStorage.setItem('movementHistory', JSON.stringify(movementHistory));
            }
        }

        // Função para calcular a data de vencimento (4 anos após a fabricação)
        function calculateExpiryDate(manufacturingDate) {
            if (!manufacturingDate) return 'N/A';
            
            const date = new Date(manufacturingDate);
            date.setFullYear(date.getFullYear() + 4);
            return date.toISOString().split('T')[0];
        }

        // Função para verificar o status do produto
        function checkProductStatus(expiryDate) {
            if (!expiryDate || expiryDate === 'N/A') {
                return { status: "Sem data", class: "status-warning" };
            }
            
            const today = new Date();
            const expiry = new Date(expiryDate);
            const oneYearBefore = new Date(expiry);
            oneYearBefore.setFullYear(oneYearBefore.getFullYear() - 1);
            
            if (today > expiry) {
                return { status: "Vencido", class: "status-expired" };
            } else if (today > oneYearBefore) {
                return { status: "Vencimento Próximo", class: "status-warning" };
            } else {
                return { status: "Dentro do Prazo", class: "status-valid" };
            }
        }

        // Função para formatar data no formato brasileiro
        function formatDate(dateString) {
            if (!dateString || dateString === 'N/A') return 'N/A';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
    </script>
</body>
</html>
